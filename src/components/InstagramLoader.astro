---
import { accounts } from "../instagram.config";

// Build the fetch URLs at build time so the inline script is self-contained
const fetchEntries = Object.entries(accounts).map(([account, { userId, token }]) => ({
    account,
    url: `https://graph.instagram.com/${userId}?fields=id,username,media_count,media{id,caption,media_url,media_type,timestamp}&access_token=${token}`,
}));
---

<script is:inline define:vars={{ fetchEntries }}>
    // Kick off API fetches immediately (runs as parser hits this script)
    window.__igPromises = {};
    fetchEntries.forEach(function(entry) {
        window.__igPromises[entry.account] = fetch(entry.url)
            .then(function(res) { return res.ok ? res.json() : null; })
            .catch(function() { return null; });
    });
</script>

<script>
    type MediaItem = {
        id: string;
        caption?: string;
        media_url: string;
        media_type: string;
        timestamp: string;
    };

    declare global {
        interface Window {
            __igPromises: Record<string, Promise<any>>;
        }
    }

    async function loadInstagramMedia() {
        for (const [account, promise] of Object.entries(window.__igPromises)) {
            try {
                const data = await promise;
                if (!data) continue;

                const images: MediaItem[] = (data.media?.data ?? [])
                    .filter((item: MediaItem) => item.media_type !== "VIDEO")
                    .slice(0, 8);

                const items = document.querySelectorAll<HTMLElement>(
                    `.insta-item[data-account="${account}"]`
                );

                for (const el of items) {
                    const offset = parseInt(el.dataset.offset ?? "0", 10);
                    const index = parseInt(el.dataset.index ?? "0", 10);
                    const mediaIndex = offset + index;

                    if (mediaIndex < images.length) {
                        const media = images[mediaIndex];
                        const img = document.createElement("img");
                        img.src = media.media_url;
                        img.alt = media.caption ?? "";
                        img.decoding = "async";
                        el.appendChild(img);
                    }
                }
            } catch {
                // Graceful degradation: placeholders remain visible
            }
        }
    }

    loadInstagramMedia();
</script>
